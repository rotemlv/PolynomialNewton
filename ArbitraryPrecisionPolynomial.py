from decimal import Decimal, getcontext

import numpy as np


def sign(x):
    """Helper function - identical to np.sign."""
    # returns -1 if x < 0 else (1 if x > 0 else 0)
    if x < 0:
        return -1
    if x > 0:
        return 1
    return 0


def midpoint(a, b):
    return Decimal(a + b) / Decimal(2)


class ArbitraryPrecisionPolynomial:
    def __init__(self, coeffs, precision=10000):
        self.coeffs = [Decimal(c) for c in coeffs]
        getcontext().prec = precision
        self.precision = precision
        self.rank = len(coeffs) - 1
        self.tolerance = Decimal(1) / (Decimal(10) ** self.precision)

    def poly_eval_horner(self, at, do_inverse=0):
        res = 0
        _coeffs = self.coeffs[::-1] if do_inverse else self.coeffs
        for val in _coeffs:
            res = (res * at) + val  # p(x) = ((((an)x) + an-1)x + an-2)
        return res

    def inverse_poly(self, at):
        return self.poly_eval_horner(at, do_inverse=1)

    def poly_sign(self, x: Decimal):
        if abs(x) < 1:
            return sign(self.poly_eval_horner(x))
        else:
            y = sign(self.inverse_poly(Decimal(1) / x))
            if x > 0:
                return y
            return -y if self.rank & 1 else y

    def verify_root_bisection(self, root, epsilon):
        a = Decimal(root) - Decimal(epsilon)
        b = Decimal(root) + Decimal(epsilon)

        a_sign = self.poly_sign(a)
        b_sign = self.poly_sign(b)
        assert a_sign != b_sign
        mid = midpoint(a, b)
        last_mid = None
        # old cond:
        # (b - a) / 2 > (Decimal(1) / (Decimal(10) ** Decimal(self.precision))):
        while last_mid != mid and b-a > self.tolerance:
            mid = midpoint(a, b)
            mid_sign = self.poly_sign(mid)
            if a_sign == mid_sign:
                a = mid
                a_sign = mid_sign
            else:
                b = mid
            last_mid = midpoint(a, b)
        return midpoint(a, b)


def old_test():
    print("Checking root: -5.919278147874181")
    epsilon = Decimal("1e-1000")
    oldr = -5.919278147874181
    pr_as_string = "-5.91927861069979979015641019909062149361776779568146108831685946586256188838357516859586393928123507003319024481231539147633283300665208284009985035260437266367280008718754239183449954620277470110406607126090361053134783835387503792529752553874738390118417747766563687999023613549421785743409361817560149512419803202329026172364543176834323984197200250830780032121156211125018761210866107968640553625505807608316060981361824115342240589047508824950673940712092794392829352403272643839254921276802346250941530801361271351462998675545248285823799801169024317054719821698000392981465340992114790784345469473655626713972558880843080657081945598213248261266656472878495947826973252965901390634031790590328008879264847057399511870609673738688283836523042163601072611326807383736714890387096611172366333808187946254177237456446901444342624514562967109466071095254556805931129915812251206643883938582862963716715213213751058372929710825234245741739912750944011567840742787854913882989497957080924790530023614716014179405665501000571506454338128554929854665561659900849343105123794145952119593913311621375932036611162405344796865084701444297097151679051573231639489518380075016280909340719053952215587741571867359962013108570499254554958651579611855887291764650158719585129366008337073727451100622628380532722207588962091931076126393924212342043415043078080706366068170076077259100165116763589681534769941922367846413724128360661268550609743879506087248458481610028072841604816829269271042624382219824897553668938014184006267341930756118436899409409574624531854184536577292585897649756159219634645971859294507229851212622126194714098404868420487793978943705316630588142810381678849991909341085631532580927388298877382637977294837221098820720425774360894837520540276917525583984739238796443281234307508050304328911399259512879602819095700416899153350386267889627617444832866682466739896935944856749949921424861527666456282982856372574586129255185791493246687713638967529084705197514346705204985538273205913782218240055431441328337649457276894129609734830648901997234588719898874046328634872865279446189160309233231939441436798861988878547418103675364456409335895371989705593738006375832027070206507960321635988413555344990659085751551973371090707892905528550854966881738425673668929265584421447192097734065853581641031418598159851267727957015440639620440286608893042747128915417514569130165012504180396473913763760966864009706727556271998565112746999100423567509220983265231655651178735340844980202663552865757744701035653478213324270394003794607488748806523266862130386381525618113632219403890070005772904560009162155296248706852671377950184402946198063097079930445361055494799394697643649713083549905556453464430181933823619498029064768153158310126781889871629850108397862653634696809344990366871474097908365710634923202689400603452660472917733566071990695381905698132652759295836085079639074833609972466772811249551781555598459066591870176728918814374020834574827766351695571063775419530989796980394035019537319622480150202870985783541193688756104582665407511366422251209328789435807165241546366972384520771148901804497933918905122010835622004858632336087447449420304124439093740459322412103964409592588990396852930520968229091873549834109764359419625212905732491291422584699768598715113631144128331972459258903230772798695649908659340117014214250497644885542930412079396668324459417998518848356038727285490572536775741334779886154456041527891135347763369808587267500468353377654043750759403466061287862749942639553009272347742724683080479875575014408569894511593000041520686580808163494117391013429803524761857852865007488890473549611629974719414351989558082115650369345339775967113723475434797818379969295124756660333829947391399573552693572658155975296744035104845158297505082769866923934212888056759212537844078706235040509283296221250391796867681698911480564170174814547185258154373279845715809523959959839742525663058282921876000545445336770381187508375347102455835233899027340462982562676917105629387176439955233626504828107934036000119495893671054901118431913815809036945570360024319363933441321805825812880933192295641127651818586321557011453322008571386763118381470384133020487089901765553562403722302848546126009746392641182635650124468625289500602025842788630772983917800484742612488440039314522730372622834117577930346201877315999548500988855585098953848916813145706680005060415005188487894024025957871305002509600321431086437366793664286794217186935323777795668373411635129338491505244065512540272685820894358111646198315887142485033400661744993476132219174397024290945217934026549166663566070765837244639565308390911311222289553606494223090617250975978936138984923641779000808222506418064089846718699300197049805595560658568193019969084896673066053207758427356881355822112558904200755863077796775406656512922256718233286724124414023277842748947211728335217259168792495758065512681194093074295998939281217699093936926582738515432187021240640949018183174207949173038725665045422687581078550720967062846057013902940294082404497551794888840540199885855299055762190845281468775704775182116370933306882517235884417376584996393609205709779158179816778713014129610953554232872319726810964838599766399369426760528388812789980187646196779913437839305141646333616007856973699010198124730933321896583330670259447623539277881702059085327095528289750970889461974381902804289628680267882656916802047197528149861467869184538030788191564640682093528741908430380620224982819963717618995798907486940424773613587817837793585717565128970322437827970584866634164698113363068357012028228162231800417846905258952666840840949647675464128539256174872096785280723195450031974598365776825249766147235664708350331854031049383935570028055663757454557448525879416869793377201487523134375855306041125050845121544722251235704538224099423780527572384336317801153989281580825046610831597661032436727208960943499294642771989621063157514445201311960165221980010011225623083068094566882610159152362895856726277060823748615905519093953972995171805785212903829412943852444757809611815456406365147368088925492999071533783906478661001583673374817127290842349045732090752970821542348386600949166057217915448427277845224236040082888567895800474013873465465833163788762367110010604772345883220241743344209804283610360716217867165468378537403533482797266936351663876835943187755381017410855264566473517747032145278746576855467860043773515110299506699998443721778029135007223673275139525296501712048132413037051467678736381943537567359558168059915048996112891288374010331066886420167348521079563037522408812655194951025672162256531551121623099235685802734472894172644722909394760992513029637578484838362051381082273863002964452057900919654969868350704651094403937567036142286281495851607160944463948210155094560728737268617567082841402272849749172378427809237307451177287613121294603514164575946237597295120632362502051698559815927574633936550047910232092431264939894575877127522022599743290542403409334351111231702852946427264856712435231104717449241050142264939806944911743857096988615609851775186521438904565694002969431883489989349310714603442388527659267753218389451143189590576522185992641057781834834463655484041226736739180581746939511990484688342222671313084724155696230440254305420863884056377284248312917983401125407186467149443402826141648348116597593375336765235836491813438740548078601652467986777150928562471568366754420003133206779291571306826383432784210675896258474264518196075771968727267042383082487139567917686149716448463524951599148804947716567359133973307145869245694420983756738733627450311149226782489707272814708158918544371537489690514911482224047852911491201613831986762983046925689846683853381945373973743162445401552363211645029311342031030763442786022270581172131190294633775066874123636724493916575833190715428034776367857307158784299543348019386333775745038310278261295153872991469200399160025754150849145329649547488186032139931327110573231806068931594482631873418319985309555217950482855811872474177472027758347738446420048521959724822464875983123911541062667435933526600700720998764208946477786012698888090864081397490911432765840027133017301893397839045494368015663275486295501244260699863161151568417306575291453591883454830282100432944787277349170538168543057684103335734105968071964580005671709680292285248686815395816584610808440730707542364694674128569341533361791592472794293388972138262152665152416086188841472189744860403979166868189664894820804149413410437903342074241778453041147476806049808152488700229564869048275249006970446482173180725982894576287920524506592566162283230205248390278569056441227805367366308572839447033402336417225541236325581160517158383823536335722948043684595463848141149631369228351082505435284673638089593035044451448841210140724940329732878266613013241496738131285954955421153840419718522617554541602014177675519460051869603237692337387977693501654399131420012662703649996666160221216451731543032919218939516386876800187787027185051077712614117889849796644215441554211759360374571413374792060022338256580581715927083969244971919317129444881733672923559863018089395734780992430959657992647219311901050164533614491299689085740034599251945933907526374914694179897564863748287421002244351718172845083752370617042754939960196969512874878226367003549301250624068550019829985661648786802838611646742712238629160307884082832759323976088179655011994066365632199243612273126661849993432917301261103806566634213554277933257056491228888356473659384805730169650976240290182865259689617859484371715191896015400513311037034951152157654727071298944278628959250086635485157741794830623812440104266036756870705815355633415556133743091092302543999912833211226409285229603775628204060462760509011948951600928339836799087866320400274999410181732492817532352815305913327768564880608033555499219622879357062085261813662456442625229136171041515286591705952158335778095961378241025686673381040257171384139732137187710902670867415085929737884155132065052988645728618908485160714972163235822"
    pr_as_string = pr_as_string[:-8900]
    pr = Decimal(pr_as_string)
    # res = polynomial.verify_root_bisection(pr, epsilon*100000)
    # print(res)
    print(np.float64(polynomial.poly_eval_horner(pr)))
    print(np.float64(polynomial.poly_eval_horner(pr + epsilon)))
    print(np.float64(polynomial.poly_eval_horner(pr - epsilon)))
    print(f"The actual root: \n{pr}")


"""
Instructions:
To use, define root you want to check, define epsilon (or leave it as is)
and call polynomial.verify_root_bisection(close-root, old-epsilon)
It will slowly(!) converge towards a more precise solution in the neighborhood of [sol - old-epsilon, sol + old-epsilon]
such that it satisfies the new tolerance (new-tolerance is equivalent to defining an epsilon of 1e-(new-tolerance) )

"""


if __name__ == '__main__':
    with open('poly_coeff(997).txt') as f:
        polynomial = f.read().splitlines()
        polynomial_coefficients = np.array(polynomial, np.float64)
        close_root_str = "-1.0295855332810584"
        close_root = Decimal(close_root_str)
        old_epsilon = 1e-6
        print(f"Verifying {close_root}! Old epsilon = {old_epsilon}")
        new_tolerance = 1000
        polynomial = ArbitraryPrecisionPolynomial(polynomial_coefficients, new_tolerance)
        res = polynomial.verify_root_bisection(Decimal(close_root), Decimal(old_epsilon))
        print(f"Calibrated root: {res}")
        print(f"Polynomial evaluated at:")
        print(f"Old root: {np.float64(polynomial.poly_eval_horner(close_root))}")
        print(f"New root: {np.float64(polynomial.poly_eval_horner(res))}")


'''
In order to verify these roots, choose precision of 10_000 (to be safe with the -5.9 result)
roots; (for epsilon = 1e-6)
(-5.919278147874181)
real root for above:
        res = Decimal("-5.91927861069979979015641019909062149361776779568146108831685946586256188838357516859586393928123507003319024481231539147633283300665208284009985035260437266367280008718754239183449954620277470110406607126090361053134783835387503792529752553874738390118417747766563687999023613549421785743409361817560149512419803202329026172364543176834323984197200250830780032121156211125018761210866107968640553625505807608316060981361824115342240589047508824950673940712092794392829352403272643839254921276802346250941530801361271351462998675545248285823799801169024317054719821698000392981465340992114790784345469473655626713972558880843080657081945598213248261266656472878495947826973252965901390634031790590328008879264847057399511870609673738688283836523042163601072611326807383736714890387096611172366333808187946254177237456446901444342624514562967109466071095254556805931129915812251206643883938582862963716715213213751058372929710825234245741739912750944011567840742787854913882989497957080924790530023614716014179405665501000571506454338128554929854665561659900849343105123794145952119593913311621375932036611162405344796865084701444297097151679051573231639489518380075016280909340719053952215587741571867359962013108570499254554958651579611855887291764650158719585129366008337073727451100622628380532722207588962091931076126393924212342043415043078080706366068170076077259100165116763589681534769941922367846413724128360661268550609743879506087248458481610028072841604816829269271042624382219824897553668938014184006267341930756118436899409409574624531854184536577292585897649756159219634645971859294507229851212622126194714098404868420487793978943705316630588142810381678849991909341085631532580927388298877382637977294837221098820720425774360894837520540276917525583984739238796443281234307508050304328911399259512879602819095700416899153350386267889627617444832866682466739896935944856749949921424861527666456282982856372574586129255185791493246687713638967529084705197514346705204985538273205913782218240055431441328337649457276894129609734830648901997234588719898874046328634872865279446189160309233231939441436798861988878547418103675364456409335895371989705593738006375832027070206507960321635988413555344990659085751551973371090707892905528550854966881738425673668929265584421447192097734065853581641031418598159851267727957015440639620440286608893042747128915417514569130165012504180396473913763760966864009706727556271998565112746999100423567509220983265231655651178735340844980202663552865757744701035653478213324270394003794607488748806523266862130386381525618113632219403890070005772904560009162155296248706852671377950184402946198063097079930445361055494799394697643649713083549905556453464430181933823619498029064768153158310126781889871629850108397862653634696809344990366871474097908365710634923202689400603452660472917733566071990695381905698132652759295836085079639074833609972466772811249551781555598459066591870176728918814374020834574827766351695571063775419530989796980394035019537319622480150202870985783541193688756104582665407511366422251209328789435807165241546366972384520771148901804497933918905122010835622004858632336087447449420304124439093740459322412103964409592588990396852930520968229091873549834109764359419625212905732491291422584699768598715113631144128331972459258903230772798695649908659340117014214250497644885542930412079396668324459417998518848356038727285490572536775741334779886154456041527891135347763369808587267500468353377654043750759403466061287862749942639553009272347742724683080479875575014408569894511593000041520686580808163494117391013429803524761857852865007488890473549611629974719414351989558082115650369345339775967113723475434797818379969295124756660333829947391399573552693572658155975296744035104845158297505082769866923934212888056759212537844078706235040509283296221250391796867681698911480564170174814547185258154373279845715809523959959839742525663058282921876000545445336770381187508375347102455835233899027340462982562676917105629387176439955233626504828107934036000119495893671054901118431913815809036945570360024319363933441321805825812880933192295641127651818586321557011453322008571386763118381470384133020487089901765553562403722302848546126009746392641182635650124468625289500602025842788630772983917800484742612488440039314522730372622834117577930346201877315999548500988855585098953848916813145706680005060415005188487894024025957871305002509600321431086437366793664286794217186935323777795668373411635129338491505244065512540272685820894358111646198315887142485033400661744993476132219174397024290945217934026549166663566070765837244639565308390911311222289553606494223090617250975978936138984923641779000808222506418064089846718699300197049805595560658568193019969084896673066053207758427356881355822112558904200755863077796775406656512922256718233286724124414023277842748947211728335217259168792495758065512681194093074295998939281217699093936926582738515432187021240640949018183174207949173038725665045422687581078550720967062846057013902940294082404497551794888840540199885855299055762190845281468775704775182116370933306882517235884417376584996393609205709779158179816778713014129610953554232872319726810964838599766399369426760528388812789980187646196779913437839305141646333616007856973699010198124730933321896583330670259447623539277881702059085327095528289750970889461974381902804289628680267882656916802047197528149861467869184538030788191564640682093528741908430380620224982819963717618995798907486940424773613587817837793585717565128970322437827970584866634164698113363068357012028228162231800417846905258952666840840949647675464128539256174872096785280723195450031974598365776825249766147235664708350331854031049383935570028055663757454557448525879416869793377201487523134375855306041125050845121544722251235704538224099423780527572384336317801153989281580825046610831597661032436727208960943499294642771989621063157514445201311960165221980010011225623083068094566882610159152362895856726277060823748615905519093953972995171805785212903829412943852444757809611815456406365147368088925492999071533783906478661001583673374817127290842349045732090752970821542348386600949166057217915448427277845224236040082888567895800474013873465465833163788762367110010604772345883220241743344209804283610360716217867165468378537403533482797266936351663876835943187755381017410855264566473517747032145278746576855467860043773515110299506699998443721778029135007223673275139525296501712048132413037051467678736381943537567359558168059915048996112891288374010331066886420167348521079563037522408812655194951025672162256531551121623099235685802734472894172644722909394760992513029637578484838362051381082273863002964452057900919654969868350704651094403937567036142286281495851607160944463948210155094560728737268617567082841402272849749172378427809237307451177287613121294603514164575946237597295120632362502051698559815927574633936550047910232092431264939894575877127522022599743290542403409334351111231702852946427264856712435231104717449241050142264939806944911743857096988615609851775186521438904565694002969431883489989349310714603442388527659267753218389451143189590576522185992641057781834834463655484041226736739180581746939511990484688342222671313084724155696230440254305420863884056377284248312917983401125407186467149443402826141648348116597593375336765235836491813438740548078601652467986777150928562471568366754420003133206779291571306826383432784210675896258474264518196075771968727267042383082487139567917686149716448463524951599148804947716567359133973307145869245694420983756738733627450311149226782489707272814708158918544371537489690514911482224047852911491201613831986762983046925689846683853381945373973743162445401552363211645029311342031030763442786022270581172131190294633775066874123636724493916575833190715428034776367857307158784299543348019386333775745038310278261295153872991469200399160025754150849145329649547488186032139931327110573231806068931594482631873418319985309555217950482855811872474177472027758347738446420048521959724822464875983123911541062667435933526600700720998764208946477786012698888090864081397490911432765840027133017301893397839045494368015663275486295501244260699863161151568417306575291453591883454830282100432944787277349170538168543057684103335734105968071964580005671709680292285248686815395816584610808440730707542364694674128569341533361791592472794293388972138262152665152416086188841472189744860403979166868189664894820804149413410437903342074241778453041147476806049808152488700229564869048275249006970446482173180725982894576287920524506592566162283230205248390278569056441227805367366308572839447033402336417225541236325581160517158383823536335722948043684595463848141149631369228351082505435284673638089593035044451448841210140724940329732878266613013241496738131285954955421153840419718522617554541602014177675519460051869603237692337387977693501654399131420012662703649996666160221216451731543032919218939516386876800187787027185051077712614117889849796644215441554211759360374571413374792060022338256580581715927083969244971919317129444881733672923559863018089395734780992430959657992647219311901050164533614491299689085740034599251945933907526374914694179897564863748287421002244351718172845083752370617042754939960196969512874878226367003549301250624068550019829985661648786802838611646742712238629160307884082832759323976088179655011994066365632199243612273126661849993432917301261103806566634213554277933257056491228888356473659384805730169650976240290182865259689617859484371715191896015400513311037034951152157654727071298944278628959250086635485157741794830623812440104266036756870705815355633415556133743091092302543999912833211226409285229603775628204060462760509011948951600928339836799087866320400274999410181732492817532352815305913327768564880608033555499219622879357062085261813662456442625229136171041515286591705952158335778095961378241025686673381040257171384139732137187710902670867415085929737884155132065052988645728618908485160714972163235822")

(-1.0404447349991122)
real root for above:
        res = Decimal(" -1.040445023932057031550542850744602703550753602470214578673792962405669746241407506840593117788097597704934809009361938043012725863080025817538092880730068726448228941851863628863788990534995104324238480224171964540733983938865581975697123983964023428521558139755139365367790590063797901431789345656993758791789137006632187210969280852715132871354383091383257478232421902900661367467268407736153778366414738899741866520473333958197636282960684382996816636133356227900410672627282915059057621296850284208166101983218610153056178851262416053345484918487831858267008037708396827722535617655497980808324249733200220456144722122770215496823757714249997875988040830302769888238077539392319522059075028605512555979551098447916737763574654745320226124572928195618960712217238336418822137375087469378155006633568210079410390751595286359269573665215264134947840287490098574437000990637956719676675336556496208547116300548626754704673827830794455520949294140948962141518797787397587987820334256818565969551760224")

(-1.0295855332810584)
real root for above:
        res = Decimal("-1.029585212355378920149338310838789954710259352164046908120379047223989326235401760215397367828985281220516522331028209173565460119440638060286014339986187876741198704076138579364197446066847183160223818752364411589001924796198957757031708066522076161133783603378965469907838938626209049569384154214076372699989888365173771202244475430977203328493287089144409383394456138019233687662917403866845202414208059654916991980240700555128100289273631257988834304041394075824437500390823141919338134987773008183906639657775093863417739500513469503785291796543212316649704059211197155448317525670965530972556543841520161944879114730464234238491512946654124660701919907803117969369799091743393076416681984686019174402363974333702561007395994485503358414325802455176399337408400159458213272750947661331968123141935615287764898588313154472425833219326105565554925809080416291316692531869111377383853693916564483104295259170679151931197433750454047194701362513202748079040920450624799925962882789462508891082725160")

(-0.8315491331185336)
(-0.28564684620108793)
(1.0000001916418877)
'''
